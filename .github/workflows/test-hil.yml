name: "Pouch HIL Tests"

on:
  workflow_dispatch:
    inputs:
      hil_board:
        required: true
        type: string
      west_board:
        required: true
        type: string
      manifest_yml:
        required: true
        type: string
      binary_file:
        required: false
        type: string
      binary_blob:
        required: false
        type: string
      gw_board:
        required: false
        type: string

  workflow_call:
    inputs:
      hil_board:
        required: true
        type: string
      west_board:
        required: true
        type: string
      manifest_yml:
        required: true
        type: string
      binary_file:
        required: false
        type: string
      binary_blob:
        required: false
        type: string
      gw_board:
        required: false
        type: string

jobs:
  build-leaf:
    name: pouch-${{ inputs.hil_board }}-build
    container: golioth/golioth-zephyr-base:0.17.0-SDK-v0
    env:
      ZEPHYR_SDK_INSTALL_DIR: /opt/toolchains/zephyr-sdk-0.17.0
      ARTIFACT_NAME: test_artifact_${{ inputs.hil_board }}-${{ inputs.manifest_yml }}-${{ inputs.binary_file }}
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: pouch
      - name: Init and update west
        run: |
          west init -l pouch --mf ${{ inputs.manifest_yml }}.yml
          west update --narrow -o=--depth=1
      - name: Install pip packages
        run: |
          uv pip install \
            -r zephyr/scripts/requirements-base.txt        \
            -r zephyr/scripts/requirements-build-test.txt  \
            -r zephyr/scripts/requirements-run-test.txt    \
            -r pouch/requirements.txt

          uv pip install          \
            cryptography==41.0.7  \
            pyasn1                \
            pyyaml                \
            cbor>=1.0.0           \
            imgtool>=1.9.0        \
            jinja2                \
            click

      - name: Download binary blobs
        if: ${{ inputs.binary_blob }}
        run: |
          west blobs fetch ${{ inputs.binary_blob }}

      - name: Compile
        shell: bash
        run: |
          west build --sysbuild -p -b ${{ inputs.west_board }} pouch/examples/ble_gatt
          cp $(find build -name ${{ inputs.binary_file }}) $ARTIFACT_NAME

      - name: Save artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test_artifact_${{ inputs.hil_board }}-${{ inputs.manifest_yml }}
          path: ${{ env.ARTIFACT_NAME }}

  test-hil:
    name: hil-test-${{ inputs.hil_board }}-${{ inputs.manifest_yml }}
    if: ${{ inputs.gw_board != '' }}
    needs:
      - build-leaf
    runs-on:
      - is_active
      - has_${{ inputs.hil_board }}
      - has_${{ inputs.gw_board }}
    timeout-minutes: 30

    container:
      image: golioth/golioth-twister-base:89df175
      env:
        ZEPHYR_SDK_INSTALL_DIR: /opt/toolchains/zephyr-sdk-0.17.0
      volumes:
        - /dev:/dev
        - /home/golioth/credentials:/opt/credentials
      options: --privileged

    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          path: pouch

      - name: Init and update west
        run: |
          rm -rf .west
          west init -l pouch --mf ${{ inputs.manifest_yml }}.yml
          west update --narrow -o=--depth=1

      - name: Install pip packages
        run: |
          uv pip install \
            -r zephyr/scripts/requirements-base.txt        \
            -r zephyr/scripts/requirements-build-test.txt  \
            -r zephyr/scripts/requirements-run-test.txt    \
            -r pouch/requirements.txt                      \
            'git+https://github.com/golioth/golioth-firmware-sdk@v0.22.0#egg=pytest_hil&subdirectory=tests/hil/scripts/pytest-hil/' \
            git+https://github.com/golioth/python-golioth-tools@v0.8.1

          uv pip install          \
            cryptography==41.0.7  \
            pyasn1                \
            pyyaml                \
            cbor>=1.0.0           \
            imgtool>=1.9.0        \
            jinja2                \
            click                 \
            smpmgr

      - name: Power On USB Hub
        run: python3 /opt/golioth-scripts/usb_hub_power.py on

      - name: Clean Binaries from Prior Runs
        shell: bash
        run: rm -rf *.bin *.hex

      - name: Download Test Firmware
        uses: actions/download-artifact@v4
        with:
          name: test_artifact_${{ inputs.hil_board }}-${{ inputs.manifest_yml }}
          path: .

      - name: Download Gateway Firmware
        uses: actions/download-artifact@v4
        with:
          path: .
          pattern: gw-artifact-*
          merge-multiple: true

      - name: Show downloads
        shell: bash
        run: ls -la .

      - name: Run Pytest
        shell: bash
        env:
          hil_board: ${{ inputs.hil_board }}
          gw_board: ${{ inputs.gw_board }}
          ARTIFACT_NAME: test_artifact_${{ inputs.hil_board }}-${{ inputs.manifest_yml }}-${{ inputs.binary_file }}
          GW_ARTIFACT_NAME: gateway-${{ inputs.gw_board }}.hex
        run: |
          source /opt/credentials/runner_env.sh
          export PATH=$PATH:/opt/SEGGER/JLink
          PORT_VAR=CI_${hil_board^^}_PORT
          SNR_VAR=CI_${hil_board^^}_SNR
          GW_PORT_VAR=CI_${gw_board^^}_PORT
          GW_SNR_VAR=CI_${gw_board^^}_SNR

          pytest pouch/examples/ble_gatt/pytest          \
              --rootdir .                                \
              --board ${hil_board}                       \
              --port ${!PORT_VAR}                        \
              --serial-number ${!SNR_VAR}                \
              --fw-image ${ARTIFACT_NAME}                \
              --api-url https://api.golioth.io           \
              --api-key ${{ secrets.MIKE_TEST_API_KEY }} \
              --gw-board=${gw_board}                     \
              --gw-port=${!GW_PORT_VAR}                  \
              --gw-fw-image=${GW_ARTIFACT_NAME}          \
              --gw-serial-number=${!GW_SNR_VAR}


      - name: Erase flash
        if: always()
        shell: bash
        env:
          hil_board: ${{ inputs.hil_board }}
          gw_board: ${{ inputs.gw_board }}
        run: |
          source /opt/credentials/runner_env.sh
          export PATH=$PATH:/opt/SEGGER/JLink
          SNR_VAR=CI_${hil_board^^}_SNR
          PORT_VAR=CI_${hil_board^^}_PORT
          cat <<EOF > erase_frdm_rw612.jlink
          r
          h
          exec EnableEraseAllFlashBanks
          erase 0x8000000 0x8624000
          sleep 30
          r
          sleep 3
          q
          EOF

          if [[ "${hil_board}" == "nrf52840dk" ]]; then
            nrfjprog --recover --snr ${!SNR_VAR}
          fi

          if [[ "${gw_board}" == "frdm_rw612" ]]; then
            JLinkExe \
              -nogui 1 \
              -if swd \
              -speed auto \
              -device RW612 \
              -CommanderScript erase_frdm_rw612.jlink \
              -SelectEmuBySN ${!SNR_VAR}
          fi

      - name: Power Off USB Hub
        if: always()
        run: python3 /opt/golioth-scripts/usb_hub_power.py off
